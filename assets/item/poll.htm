<div class="-message">{ body | raw }</div>
<div class="poll">
  <form {$f} >
    {#questions}
      <label>
	{if multi}
	  <input type="checkbox" value="{ n | string_of_int | esc }"/>
	{else}
	  <input type="radio" name="vote" value="{ n | string_of_int | esc }"/>
	{/if} {label}
	<div class="-stats">
	  <div class="-bar">
	    <div style="width:0%"></div>
	    <span></span>
	  </div>
	  <a href="javascript:void(0)">?</a>
	</div>
      </label> 
    {/#}
  </form>
</div>

<script type="count: int list, total: int, answers: int list option, url: string"> 
n = here.$f.children().length

fill = () -> 
  div = 100 / Math.max(total, 1) 
  here.$f.children().each (i) -> 
    $t = $ @
    p = count[i] * div

    $i = $t.find("input")
    ic = $i.is ":checked" 
    sc = answers && i in answers
    $i.attr "checked", sc if ic != sc 

    $t.find(".-bar div").css "width", p.toFixed(2) + "%"
    $t.find(".-bar span").text count[i]
    $t.find(".-bar").toggleClass "-s", p < 5

do fill

update = () -> 

  sel = []

  here.$f.find("input:checked").each () -> 
    sel.push parseInt $(@).val(), 10

  return if answers is sel 

  mySendId = ++sendId
  setTimeout send(mySendId), 1000 

  if answers is null
    total++
  else
    count[i]-- for i in answers

  answers = sel
  count[i]++ for i in answers
  do fill

here.$f.find("input").change update 

sendId = 0
send = (mySendId) ->
  () ->   
    return if mySendId != sendId
    post url, answers, () -> 
      false

</script> 

<style>
.poll {
  margin: 8px 0;

  label {
    display: block;
    padding: 5px;
    border: 1px solid #CCC;
    margin-bottom: -1px;
    line-height: 20px;
  }

  input {
    vertical-align: top;
  }

  .-stats {
    float: right;
    position: relative;
    padding-right: 30px;

    .-bar {
      background-color: #EEE;
      background: -webkit-linear-gradient(top, #FFF 0%,#EEE 100%);
      background: -moz-linear-gradient(top, #FFF 0%,#EEE 100%);
      border: 1px solid #777;
      width: 200px;
      height: 18px;
      position: relative;
    }

    .-bar div {
      float: left;
      border: 1px solid #070;
      margin: -1px;
      height: 18px;
      background-color: #CCC;
      background-color: #4C4;
      background: -webkit-linear-gradient(top, #4C4 0%,#2A2 100%);
      background: -moz-linear-gradient(top, #4C4 0%,#2A2 100%);
    }

    .-bar span {
      position: absolute;
      left: 5px;
      top: 0;
      visibility: hidden;
      color: white;
      text-shadow: 0 -1px 0 #070;
      font-weight: bold;
    }

    .-bar.-s span {
      position: relative;
      color: #555;
      text-shadow: 0 1px 0 white;
    }

    a {
      display: block;
      height: 18px;
      width: 18px;
      border: 1px solid #777;
      position: absolute;
      right: 0;
      top: 0;
      color: #555;
      font-weight: bold;
      font-size: 14px;
      line-height: 17px;
      font-family: 'Open Sans Condensed', sans-serif;
      border-radius: 2px;
      background-color: #EEE;
      background: -webkit-linear-gradient(top, #FFF 0%,#EEE 100%);
      background: -moz-linear-gradient(top, #FFF 0%,#EEE 100%);
      box-shadow: 0 0 3px #BBB;
      text-decoration: none;
      text-shadow: 0 1px 0 white;
      text-align: center;

      &:hover {
        background-color: #DDD;
        background: -webkit-linear-gradient(top, #FFF 0%,#EEE 100%);
        background: -moz-linear-gradient(top, #FFF 0%,#EEE 100%);
        box-shadow: 0 0 3px #555;
        color: #333;
      }
    }
  }

  label:hover .-stats .-bar span {
    visibility: visible;
  }

}

</style>
