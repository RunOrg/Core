<form {$form} style="width:408px;margin:auto" action="" method="POST">
  
  <input {$pic} type="hidden" name="pic"/>
  <div class="upload-picture">
    <img class="-l" src="/public/img/404_large.png"/>
    <img class="-s" src="/public/img/404_small.png"/>
    <a {$upload} class="action-button" style="float:right" href="javascript:void(0)">
      { `MeAccount_Picture_Edit } 
    </a>
  </div>
  
  <div style="text-align:right; margin-top: 20px">
    <button {$submit} type="submit"><span>{ `MeAccount_Picture_Submit }</span></button>
    <a style="display:inline-block" href="{back}" class="action-button">{ `MeAccount_Picture_Cancel }</a>
  </div>
  
</form>

<script type="url:json,upload:string,pics:string">

$f = here.$form
$p = here.$pic

here.$submit.attr("disabled",false)

$f.submit -> 
  data = 
    template: $("input[name='template']:checked").val()
    name: here.$name.val()
    pic: $p.val() || null
  return false if !data.template || !data.name
  here.$submit.attr("disabled","disabled")
  boxPost url, data, (result) -> 
    here.$submit.attr("disabled",false)
    call result.code
  false

refresh = -> 
  [id,proof] = $p.val().split("/")
  return if !id || !proof 
  $i = $p.next().addClass("-loading")
  $.getJSON pics, {id:id,proof:proof}, (data) -> 
    return if id != $p.val().split("/")[0] 
    return setTimeout refresh, 1000 if !data.large
    $i.find(".-l").attr("src",data.large)
    $i.find(".-s").attr("src",data.small)
    $i.removeClass("-loading")
        
here.$upload.click -> 
  $iframe = $ "<iframe/>", {src : upload}  
  close = -> 
    $iframe.parent(".-images").removeClass("-up")
    do $iframe.remove
  $(@).parent(".-images").addClass("-up").prepend($iframe)
  $iframe.load -> 
    location = $iframe.contents().get(0).location.href
    do close if /cancel/.test location
    if /confirm/.test location      
      what = /[a-zA-Z0-9]*\/[a-zA-Z0-9]*\?/.exec(location)[0]            
      what = what.substr 0, what.length-1
      $p.val(what)
      do close
      do refresh

</script>
